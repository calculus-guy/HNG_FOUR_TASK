# System Architecture Diagram

## ğŸ—ï¸ Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT LAYER                                 â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Mobile  â”‚  â”‚   Web   â”‚  â”‚  Admin  â”‚  â”‚  API    â”‚                    â”‚
â”‚  â”‚   App   â”‚  â”‚  Client â”‚  â”‚  Panel  â”‚  â”‚ Consumerâ”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â”‚
â”‚       â”‚            â”‚            â”‚            â”‚                           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                          â”‚                                                â”‚
â”‚                          â”‚ HTTP/REST                                      â”‚
â”‚                          â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API GATEWAY (Port 3000)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Rate Limiting (100 req/min)                                     â”‚  â”‚
â”‚  â”‚  â€¢ Request Validation (class-validator)                            â”‚  â”‚
â”‚  â”‚  â€¢ Idempotency Check (Redis)                                       â”‚  â”‚
â”‚  â”‚  â€¢ Correlation ID Generation                                       â”‚  â”‚
â”‚  â”‚  â€¢ Swagger Documentation (/api/docs)                               â”‚  â”‚
â”‚  â”‚  â€¢ Health Checks (/api/v1/health)                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                     â”‚                      â”‚                    â”‚
â”‚         â”‚                     â”‚                      â”‚                    â”‚
â”‚         â”‚ gRPC :50051         â”‚ gRPC :50052          â”‚ RabbitMQ           â”‚
â”‚         â”‚ (Low Latency)       â”‚ (Low Latency)        â”‚ (Async)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                      â”‚
          â–¼                     â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER SERVICE    â”‚  â”‚ TEMPLATE SERVICE â”‚  â”‚    RABBITMQ        â”‚
â”‚   (Port 3001)    â”‚  â”‚   (Port 3002)    â”‚  â”‚   (Port 5672)      â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ REST API     â”‚ â”‚  â”‚ â”‚ REST API     â”‚ â”‚  â”‚ â”‚   Exchange     â”‚ â”‚
â”‚ â”‚ - POST /usersâ”‚ â”‚  â”‚ â”‚ - POST /tmpl â”‚ â”‚  â”‚ â”‚ notifications. â”‚ â”‚
â”‚ â”‚ - GET /:id   â”‚ â”‚  â”‚ â”‚ - GET /:id   â”‚ â”‚  â”‚ â”‚    direct      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚          â”‚         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ gRPC Server  â”‚ â”‚  â”‚ â”‚ gRPC Server  â”‚ â”‚  â”‚ â”‚  Routing Keys  â”‚ â”‚
â”‚ â”‚ GetUserById  â”‚ â”‚  â”‚ â”‚ GetTemplate  â”‚ â”‚  â”‚ â”‚ â€¢ email        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚ â€¢ push         â”‚ â”‚
â”‚         â”‚        â”‚  â”‚         â”‚        â”‚  â”‚ â”‚ â€¢ failed       â”‚ â”‚
â”‚         â–¼        â”‚  â”‚         â–¼        â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚          â”‚         â”‚
â”‚ â”‚  PostgreSQL  â”‚ â”‚  â”‚ â”‚  PostgreSQL  â”‚ â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   user_db    â”‚ â”‚  â”‚ â”‚ template_db  â”‚ â”‚  â”‚ â”‚    Queues      â”‚ â”‚
â”‚ â”‚              â”‚ â”‚  â”‚ â”‚              â”‚ â”‚  â”‚ â”‚ â€¢ email.queue  â”‚ â”‚
â”‚ â”‚ Users Table  â”‚ â”‚  â”‚ â”‚ Templates    â”‚ â”‚  â”‚ â”‚ â€¢ push.queue   â”‚ â”‚
â”‚ â”‚ Preferences  â”‚ â”‚  â”‚ â”‚ Versions     â”‚ â”‚  â”‚ â”‚ â€¢ failed.queue â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚                                      â”‚
                          â–¼                                      â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  EMAIL SERVICE   â”‚                  â”‚  PUSH SERVICE    â”‚
               â”‚   (Port 3003)    â”‚                  â”‚   (Port 3004)    â”‚
               â”‚                  â”‚                  â”‚                  â”‚
               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
               â”‚ â”‚ RabbitMQ     â”‚ â”‚                  â”‚ â”‚ RabbitMQ     â”‚ â”‚
               â”‚ â”‚ Consumer     â”‚ â”‚                  â”‚ â”‚ Consumer     â”‚ â”‚
               â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
               â”‚        â”‚         â”‚                  â”‚        â”‚         â”‚
               â”‚        â–¼         â”‚                  â”‚        â–¼         â”‚
               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
               â”‚ â”‚ Email Serviceâ”‚ â”‚                  â”‚ â”‚ Push Service â”‚ â”‚
               â”‚ â”‚ â€¢ Template   â”‚ â”‚                  â”‚ â”‚ â€¢ FCM Client â”‚ â”‚
               â”‚ â”‚   Rendering  â”‚ â”‚                  â”‚ â”‚ â€¢ Token      â”‚ â”‚
               â”‚ â”‚ â€¢ SMTP Send  â”‚ â”‚                  â”‚ â”‚   Validation â”‚ â”‚
               â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
               â”‚        â”‚         â”‚                  â”‚        â”‚         â”‚
               â”‚        â–¼         â”‚                  â”‚        â–¼         â”‚
               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
               â”‚ â”‚ Circuit      â”‚ â”‚                  â”‚ â”‚ Circuit      â”‚ â”‚
               â”‚ â”‚ Breaker      â”‚ â”‚                  â”‚ â”‚ Breaker      â”‚ â”‚
               â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
               â”‚        â”‚         â”‚                  â”‚        â”‚         â”‚
               â”‚        â–¼         â”‚                  â”‚        â–¼         â”‚
               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
               â”‚ â”‚ Retry Logic  â”‚ â”‚                  â”‚ â”‚ Retry Logic  â”‚ â”‚
               â”‚ â”‚ (Max 3x)     â”‚ â”‚                  â”‚ â”‚ (Max 3x)     â”‚ â”‚
               â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
               â”‚        â”‚         â”‚                  â”‚        â”‚         â”‚
               â”‚        â–¼         â”‚                  â”‚        â–¼         â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                                     â”‚
                        â–¼                                     â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   SMTP Server    â”‚                  â”‚  Firebase FCM    â”‚
               â”‚   (Mailtrap)     â”‚                  â”‚                  â”‚
               â”‚                  â”‚                  â”‚  Push to Devices â”‚
               â”‚  Send Email      â”‚                  â”‚  - Android       â”‚
               â”‚  to User         â”‚                  â”‚  - iOS           â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  - Web           â”‚
                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SHARED INFRASTRUCTURE                              â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚     REDIS       â”‚  â”‚   POSTGRESQL    â”‚  â”‚    RABBITMQ     â”‚         â”‚
â”‚  â”‚   (Port 6379)   â”‚  â”‚   (Port 5432)   â”‚  â”‚   (Port 5672)   â”‚         â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚         â”‚
â”‚  â”‚ â€¢ Caching       â”‚  â”‚ â€¢ user_db       â”‚  â”‚ â€¢ Message Brokerâ”‚         â”‚
â”‚  â”‚ â€¢ Idempotency   â”‚  â”‚ â€¢ template_db   â”‚  â”‚ â€¢ Queues        â”‚         â”‚
â”‚  â”‚ â€¢ Rate Limiting â”‚  â”‚                 â”‚  â”‚ â€¢ DLQ           â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Data Flow Diagram

### Flow 1: Send Notification Request

```
1. POST /api/v1/notifications/send
   â†“
2. API Gateway receives request
   â”‚
   â”œâ”€â†’ Validate request (class-validator)
   â”‚
   â”œâ”€â†’ Check rate limit (Redis)
   â”‚    â€¢ 100 req/min per IP
   â”‚    â€¢ Returns 429 if exceeded
   â”‚
   â”œâ”€â†’ Check idempotency (Redis)
   â”‚    â€¢ Key: notification:{user_id}:{template_id}
   â”‚    â€¢ TTL: 24 hours
   â”‚    â€¢ Returns 400 if duplicate
   â”‚
   â”œâ”€â†’ Get User (gRPC call to User Service)
   â”‚    â€¢ Check Redis cache first
   â”‚    â€¢ If miss, call gRPC
   â”‚    â€¢ Cache for 5 minutes
   â”‚
   â”œâ”€â†’ Get Template (gRPC call to Template Service)
   â”‚    â€¢ Check Redis cache first
   â”‚    â€¢ If miss, call gRPC
   â”‚    â€¢ Cache for 10 minutes
   â”‚
   â”œâ”€â†’ Check user preferences
   â”‚    â€¢ Is channel enabled?
   â”‚    â€¢ Check quiet hours
   â”‚
   â””â”€â†’ Publish to RabbitMQ
        â€¢ Exchange: notifications.direct
        â€¢ Routing Key: notification.email OR notification.push
        â€¢ Message includes: user data, template, context
        â”‚
        â”œâ”€â†’ email.queue â†’ Email Service
        â”‚
        â””â”€â†’ push.queue â†’ Push Service
             â”‚
             â–¼
3. Return 202 Accepted
   {
     "success": true,
     "message": "Notification queued",
     "data": {
       "correlation_id": "uuid",
       "status": "queued"
     }
   }
```

### Flow 2: Email Service Processing

```
1. Email Consumer receives message from email.queue
   â†“
2. Parse notification message
   â€¢ Extract user_id, template_id, context, correlation_id
   â†“
3. Render template
   â€¢ Replace {{variables}} with context values
   â€¢ Create HTML email body
   â†“
4. Send email via Circuit Breaker
   â”œâ”€â†’ Circuit CLOSED: Try to send
   â”‚   â”œâ”€â†’ Success
   â”‚   â”‚   â€¢ ACK message
   â”‚   â”‚   â€¢ Log success
   â”‚   â”‚   â€¢ Update metrics
   â”‚   â”‚
   â”‚   â””â”€â†’ Failure
   â”‚       â”œâ”€â†’ Retry #1 (after 1s)
   â”‚       â”œâ”€â†’ Retry #2 (after 2s)
   â”‚       â””â”€â†’ Retry #3 (after 4s)
   â”‚           â”‚
   â”‚           â””â”€â†’ All retries failed
   â”‚               â€¢ NACK message
   â”‚               â€¢ Send to failed.queue (DLQ)
   â”‚               â€¢ Log failure
   â”‚
   â””â”€â†’ Circuit OPEN: Don't send
       â€¢ Wait for reset timeout (30s)
       â€¢ NACK message â†’ retry later
```

### Flow 3: Push Service Processing

```
1. Push Consumer receives message from push.queue
   â†“
2. Parse notification message
   â€¢ Extract FCM token, title, body
   â†“
3. Validate FCM token
   â”œâ”€â†’ Invalid token
   â”‚   â€¢ ACK message (don't retry)
   â”‚   â€¢ Log invalid token
   â”‚
   â””â”€â†’ Valid token
       â†“
4. Send push via Circuit Breaker
   â”œâ”€â†’ Circuit CLOSED: Try to send
   â”‚   â”œâ”€â†’ Success
   â”‚   â”‚   â€¢ ACK message
   â”‚   â”‚   â€¢ Log success
   â”‚   â”‚
   â”‚   â””â”€â†’ Failure
   â”‚       â”œâ”€â†’ Retry #1 (after 1s)
   â”‚       â”œâ”€â†’ Retry #2 (after 2s)
   â”‚       â””â”€â†’ Retry #3 (after 4s)
   â”‚           â”‚
   â”‚           â””â”€â†’ All retries failed
   â”‚               â€¢ NACK message
   â”‚               â€¢ Send to failed.queue (DLQ)
   â”‚
   â””â”€â†’ Circuit OPEN
       â€¢ NACK â†’ retry later
```

## ğŸ”„ Circuit Breaker States

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   CLOSED    â”‚ â† Normal operation
        â”‚ (Requests   â”‚
        â”‚  flow)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Failures >= threshold (5)
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    OPEN     â”‚ â† All requests fail fast
        â”‚ (Blocked)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ After reset timeout (30s)
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ HALF-OPEN   â”‚ â† Testing if service recovered
        â”‚ (Testing)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€â†’ Success â†’ Back to CLOSED
               â”‚
               â””â”€â†’ Failure â†’ Back to OPEN
```

## ğŸ—„ï¸ Database Schema

### User Service Database (user_db)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    fcm_token TEXT,
    email_enabled BOOLEAN DEFAULT true,
    push_enabled BOOLEAN DEFAULT true,
    quiet_hours_start TIME,
    quiet_hours_end TIME,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);
```

### Template Service Database (template_db)

```sql
CREATE TABLE templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) UNIQUE NOT NULL,
    subject VARCHAR(500),
    body TEXT NOT NULL,
    version INTEGER DEFAULT 1,
    language VARCHAR(10) DEFAULT 'en',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_templates_name ON templates(name);

CREATE TABLE template_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID REFERENCES templates(id),
    version INTEGER NOT NULL,
    subject VARCHAR(500),
    body TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

## ğŸ”‘ Redis Keys Structure

```
# Idempotency
notification:{user_id}:{template_id}:{channel}  â†’ "1" (TTL: 24h)

# User Cache
user:{user_id}  â†’ JSON (TTL: 5min)

# Template Cache
template:{template_id}  â†’ JSON (TTL: 10min)

# Rate Limiting
ratelimit:{ip_address}  â†’ counter (TTL: 60s)
```

## ğŸ“ˆ Performance Metrics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Performance Targets (Assignment)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Throughput:    1,000+ req/min        â”‚
â”‚  Latency:       < 100ms (Gateway)      â”‚
â”‚  Success Rate:  99.5%                  â”‚
â”‚  Scalability:   Horizontal             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service Response Times                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  API Gateway:     < 50ms               â”‚
â”‚  gRPC Calls:      < 10ms               â”‚
â”‚  Database Query:  < 20ms               â”‚
â”‚  Queue Publish:   < 5ms                â”‚
â”‚  Email Send:      < 2s                 â”‚
â”‚  Push Send:       < 1s                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CLIENT                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 1. HTTPS/TLS
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       API GATEWAY                    â”‚
â”‚  â€¢ Rate Limiting (DoS Protection)    â”‚
â”‚  â€¢ Input Validation (XSS, Injection) â”‚
â”‚  â€¢ CORS Configuration                â”‚
â”‚  â€¢ JWT Authentication (TODO)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 2. gRPC (Internal Network)
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    INTERNAL SERVICES                 â”‚
â”‚  â€¢ No public exposure                â”‚
â”‚  â€¢ Service mesh (optional)           â”‚
â”‚  â€¢ mTLS (optional)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Docker Network

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Network: notification-network      â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   API    â”‚  â”‚   User   â”‚  â”‚ Template â”‚ â”‚
â”‚  â”‚ Gateway  â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Email   â”‚  â”‚   Push   â”‚               â”‚
â”‚  â”‚ Service  â”‚  â”‚ Service  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Postgres â”‚  â”‚ RabbitMQ â”‚  â”‚  Redis   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚  All services can talk to each other       â”‚
â”‚  via service names (DNS resolution)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Scaling Strategy

```
Horizontal Scaling:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Load       â”‚
â”‚  Balancer   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼          â–¼          â–¼          â–¼
   â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”
   â”‚ API â”‚    â”‚ API â”‚    â”‚ API â”‚    â”‚ API â”‚
   â”‚  #1 â”‚    â”‚  #2 â”‚    â”‚  #3 â”‚    â”‚  #4 â”‚
   â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜

RabbitMQ handles load distribution to workers:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Queue   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚
   â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
   â–¼    â–¼    â–¼    â–¼    â–¼
 [W1] [W2] [W3] [W4] [W5]  â† Email Workers
```

---

**Use this diagram for**:
- Understanding system flow
- Team discussions
- Debugging issues
- Presentation to evaluators
- System design documentation
